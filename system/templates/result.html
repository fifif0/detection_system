{% extends 'base.html' %} {% block content %} {% load widget_tweaks %}
<section class="container pt-5 mt-3">
    <div class="container text-center ps-5 pe-5 mb-3 pb-5">
        <h1 class="h3 font-weight-normal text-center pb-5">Wynik analizy</h1>

        <p><strong>Analizowana Wiadomość:</strong> {{ news }}</p>
        <p><strong>Wybrany Model:</strong> {{ model_choice }}</p>
        <p><strong>Wybrany Wektoryzator:</strong> {{ vector_choice }}</p>
        <p><strong>Wynik Analizy:</strong> {{ result }}</p>

        <h1 class="h3 font-weight-normal text-center pb-2">Linki do wyszukiwania:</h1>
        <div class="containertext-center ps-5 pe-5 mb-3 pb-5">
            <div id="entity-container">
                {% for entity, query_url in search_queries %}
                <button class="entity-button" data-entity="{{ entity }}">{{ entity }}</button>
                {% endfor %}
            </div>

            <button type="submit" class="btn btn-danger mt-4" id="generate-query-btn">Generuj Zapytanie</button>
            <meta name="csrf-token" content="{{ csrf_token }}">
            <div id="generated-query-container" class="mt-3">
                <!-- Tutaj pojawią się wygenerowane zapytania -->
            </div>
        </div>
        <div class="container text-center">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <p><a href=" {% url 'analyze_news' %}" target="_self"
                            class="float-end  bg-danger rounded-3 bold-link fw-bold py-2 px-4">Analizuj inną
                            wiadomość</a>
                    </p>
                </div>
                <div class="col-md-4">
                    <p><a href="{% url 'index' %}" target="_self"
                            class="float-end  bg-danger rounded-3 bold-link fw-bold py-2 px-4">Powrót do strony
                            głównej</a>
                    </p>

                </div>
            </div>
        </div>
        <script>
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            document.addEventListener('DOMContentLoaded', function () {
                const entityButtons = document.querySelectorAll('.entity-button');
                const queryContainer = document.getElementById('generated-query-container');
                const generateQueryBtn = document.getElementById('generate-query-btn');
                let selectedEntities = [];

                entityButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const entity = this.getAttribute('data-entity');
                        if (selectedEntities.includes(entity)) {
                            const index = selectedEntities.indexOf(entity);
                            selectedEntities.splice(index, 1);
                            this.classList.remove('selected');
                        } else {
                            selectedEntities.push(entity);
                            this.classList.add('selected');
                        }
                    });
                });

                generateQueryBtn.addEventListener('click', function () {
                    fetch('/generate_query/', {
                        method: 'POST',
                        body: JSON.stringify({ selectedEntities: selectedEntities }),
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'),
                        }
                    })
                        .then(response => response.json())
                        .then(data => {

                            if (data.query_url) {
                                queryContainer.innerHTML = `<pre>${data.query_url}</pre>`;
                            } else {
                                queryContainer.innerHTML = '<p>Wystąpił błąd podczas generowania zapytania.</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            queryContainer.innerHTML = '<p>Wystąpił błąd podczas generowania zapytania.</p>';
                        });
                });
            });
        </script>


</section>
{% endblock %}